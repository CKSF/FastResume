<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Optimizer</title>
    <!-- Include Quill stylesheet -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        /* Basic styling for the app */
        body {
            font-family: sans-serif;
            line-height: 1.6;
            margin: 20px;
        }
        h1, h2 {
            color: #333;
        }
        textarea, input[type="file"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        input[type="submit"], button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        input[type="submit"]:hover, button:hover {
            background-color: #45a049;
        }
        hr {
            margin: 20px 0;
        }
        
        /* 新增：并行布局样式 */
        .main-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .left-panel {
            flex: 1;
            min-width: 0; /* 防止flex项目溢出 */
        }
        
        .right-panel {
            flex: 1;
            min-width: 0;
        }
        
        #editor {
            border: 1px solid #ccc;
            height: 400px;
        }
        
        #pdf-preview-container {
            margin-top: 0;
        }
        
        #pdf-preview-iframe {
            width: 100%;
            height: 1000px;
            border: 1px solid #ccc;
        }
        
        .section-item:hover {
            background: #d4edda !important;
            border-color: #a3d4a8 !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section-item.dragging {
            opacity: 0.6 !important;
            transform: rotate(2deg) !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
            z-index: 1000;
        }
        
        .section-item.drag-over {
            border-color: #007bff !important;
            background: #e3f2fd !important;
            border-width: 2px !important;
        }
        
        .drag-handle {
            opacity: 0.5;
            transition: opacity 0.2s ease;
        }
        
        .section-item:hover .drag-handle {
            opacity: 1;
        }
        
        .drop-indicator {
            height: 3px;
            background: #007bff;
            margin: 2px 0;
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .drop-indicator.active {
            opacity: 1;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <h1>Resume Optimizer</h1>
    <p style="color:grey; font-size: 0.9em;">For your privacy, personal identifiable information (such as emails and phone numbers) will be automatically redacted before processing.</p>
    <form id="upload-form" action="/upload" method="post" enctype="multipart/form-data">
        <h2>Job Description</h2>
        <textarea name="job_description" rows="10" cols="50"></textarea>
        <h2>Resume</h2>
        <input type="file" name="resume">
        <br><br>
        <input type="submit" value="Optimize Resume">
    </form>

    <hr>

    <div class="main-container">
        <div class="left-panel">
            <h2>Enhanced Resume</h2>
            <div id="editor"></div>
            <br>
            
            <!-- Section Toggle Controls -->
            <div id="section-controls" style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9;">
                <h3 style="margin-top: 0;">简历部分控制</h3>
                
                <!-- Integrated Section Order and Toggle Control -->
                <div style="margin-bottom: 15px;">
                    <h4 style="margin: 10px 0 5px 0; font-size: 14px;">部分顺序与显示控制 (拖拽调整顺序，勾选控制显示):</h4>
                    <ul id="section-order-list" style="list-style: none; padding: 0; margin: 0;">
                        <li draggable="true" data-section="summary" class="section-item" style="padding: 8px 12px; margin: 3px 0; background: #e8f4f8; border: 1px solid #b8d4da; border-radius: 5px; cursor: move; display: flex; align-items: center; transition: all 0.2s ease;">
                            <input type="checkbox" id="toggle-summary" checked style="margin-right: 10px; cursor: pointer;">
                            <span class="drag-handle" style="margin-right: 8px; color: #666; font-size: 12px;">⋮⋮</span>
                            <span class="section-label">📝 个人总结</span>
                        </li>
                        <li draggable="true" data-section="experience" class="section-item" style="padding: 8px 12px; margin: 3px 0; background: #e8f4f8; border: 1px solid #b8d4da; border-radius: 5px; cursor: move; display: flex; align-items: center; transition: all 0.2s ease;">
                            <input type="checkbox" id="toggle-experience" checked style="margin-right: 10px; cursor: pointer;">
                            <span class="drag-handle" style="margin-right: 8px; color: #666; font-size: 12px;">⋮⋮</span>
                            <span class="section-label">💼 工作经历</span>
                        </li>
                        <li draggable="true" data-section="projects" class="section-item" style="padding: 8px 12px; margin: 3px 0; background: #e8f4f8; border: 1px solid #b8d4da; border-radius: 5px; cursor: move; display: flex; align-items: center; transition: all 0.2s ease;">
                            <input type="checkbox" id="toggle-projects" checked style="margin-right: 10px; cursor: pointer;">
                            <span class="drag-handle" style="margin-right: 8px; color: #666; font-size: 12px;">⋮⋮</span>
                            <span class="section-label">🚀 项目经历</span>
                        </li>
                        <li draggable="true" data-section="education" class="section-item" style="padding: 8px 12px; margin: 3px 0; background: #e8f4f8; border: 1px solid #b8d4da; border-radius: 5px; cursor: move; display: flex; align-items: center; transition: all 0.2s ease;">
                            <input type="checkbox" id="toggle-education" checked style="margin-right: 10px; cursor: pointer;">
                            <span class="drag-handle" style="margin-right: 8px; color: #666; font-size: 12px;">⋮⋮</span>
                            <span class="section-label">🎓 教育背景</span>
                        </li>
                        <li draggable="true" data-section="skills" class="section-item" style="padding: 8px 12px; margin: 3px 0; background: #e8f4f8; border: 1px solid #b8d4da; border-radius: 5px; cursor: move; display: flex; align-items: center; transition: all 0.2s ease;">
                            <input type="checkbox" id="toggle-skills" checked style="margin-right: 10px; cursor: pointer;">
                            <span class="drag-handle" style="margin-right: 8px; color: #666; font-size: 12px;">⋮⋮</span>
                            <span class="section-label">⚡ 技能专长</span>
                        </li>
                        <li draggable="true" data-section="publications" class="section-item" style="padding: 8px 12px; margin: 3px 0; background: #e8f4f8; border: 1px solid #b8d4da; border-radius: 5px; cursor: move; display: flex; align-items: center; transition: all 0.2s ease;">
                            <input type="checkbox" id="toggle-publications" checked style="margin-right: 10px; cursor: pointer;">
                            <span class="drag-handle" style="margin-right: 8px; color: #666; font-size: 12px;">⋮⋮</span>
                            <span class="section-label">📚 发表论文</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <label for="template-select">Choose a template:</label>
            <select name="templates" id="template-select">
                <option value="default.html">Default</option>
            </select>
            <button id="download-btn">Download as PDF</button>
            <button id="preview-btn">Real-time Preview</button>
        </div>
        
        <div class="right-panel">
            <div id="pdf-preview-container" style="display: none;">
                <h3>PDF Preview</h3>
                <iframe id="pdf-preview-iframe"></iframe>
            </div>
        </div>
    </div>

    <!-- Include the Quill library -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let enhancedResumeData = null;
            let syncTimeout = null;
            
            var quill = new Quill('#editor', {
                theme: 'snow'
            });

            // 智能解析编辑器内容的函数
            function parseEditorContent(content) {
                const lines = content.split('\n').filter(line => line.trim());
                const parsedData = {};
                let currentSection = null;
                let currentItem = null;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // 识别section标题
                    if (line.toLowerCase().includes('summary') || line.toLowerCase().includes('个人总结')) {
                        currentSection = 'summary';
                        continue;
                    } else if (line.toLowerCase().includes('experience') || line.toLowerCase().includes('工作经历')) {
                        currentSection = 'experience';
                        parsedData.experience = [];
                        currentItem = null;
                        continue;
                    } else if (line.toLowerCase().includes('projects') || line.toLowerCase().includes('项目经历')) {
                        currentSection = 'projects';
                        parsedData.projects = [];
                        currentItem = null;
                        continue;
                    } else if (line.toLowerCase().includes('education') || line.toLowerCase().includes('教育背景')) {
                        currentSection = 'education';
                        parsedData.education = [];
                        currentItem = null;
                        continue;
                    } else if (line.toLowerCase().includes('skills') || line.toLowerCase().includes('技能专长')) {
                        currentSection = 'skills';
                        parsedData.skills = [];
                        currentItem = null;
                        continue;
                    } else if (line.toLowerCase().includes('publications') || line.toLowerCase().includes('发表论文')) {
                        currentSection = 'publications';
                        parsedData.publications = [];
                        currentItem = null;
                        continue;
                    }
                    
                    // 根据当前section处理内容
                    if (currentSection === 'summary') {
                        if (!parsedData.summary) parsedData.summary = '';
                        parsedData.summary += (parsedData.summary ? ' ' : '') + line;
                    } else if (currentSection === 'experience') {
                        // 检测日期格式 (如 "Sep 2024 – Present", "Jan 2024 – Jan 2025")
                        const datePattern = /\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|\d{4})\s*[–-]\s*(Present|\d{4}|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i;
                        
                        if (datePattern.test(line)) {
                            // 这是日期行，应该属于当前项目
                            if (currentItem) {
                                const dates = line.split(/[–-]/).map(d => d.trim());
                                currentItem.start_date = dates[0] || '';
                                currentItem.end_date = dates[1] || '';
                            }
                        } else if (line.startsWith('•') || line.startsWith('-') || line.startsWith('*') || line.startsWith('◦')) {
                            // 这是描述项
                            if (currentItem) {
                                currentItem.description.push(line.replace(/^[•\-*◦]\s*/, ''));
                            }
                        } else if (line && !line.match(/^\s*$/)) {
                            // 这可能是新的工作项目标题
                            currentItem = {
                                company: line,
                                title: '',
                                start_date: '',
                                end_date: '',
                                description: []
                            };
                            parsedData.experience.push(currentItem);
                        }
                    } else if (currentSection === 'projects') {
                        // 检测日期格式
                        const datePattern = /\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|\d{4})\s*[–-]\s*(Present|\d{4}|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i;
                        
                        if (datePattern.test(line)) {
                            // 这是日期行
                            if (currentItem) {
                                currentItem.date = line;
                                const dates = line.split(/[–-]/).map(d => d.trim());
                                currentItem.start_date = dates[0] || '';
                                currentItem.end_date = dates[1] || '';
                            }
                        } else if (line.startsWith('•') || line.startsWith('-') || line.startsWith('*') || line.startsWith('◦')) {
                            // 这是描述项
                            if (currentItem) {
                                currentItem.description.push(line.replace(/^[•\-*◦]\s*/, ''));
                            }
                        } else if (line && !line.match(/^\s*$/)) {
                            // 这可能是新的项目标题
                            currentItem = {
                                name: line,
                                date: '',
                                start_date: '',
                                end_date: '',
                                description: []
                            };
                            parsedData.projects.push(currentItem);
                        }
                    } else if (currentSection === 'skills') {
                        if (line.startsWith('•') || line.startsWith('-') || line.startsWith('*')) {
                            parsedData.skills.push(line.substring(1).trim());
                        } else if (line) {
                            parsedData.skills.push(line);
                        }
                    }
                }
                
                return parsedData;
            }
            
            // 添加实时同步功能
            function syncPdfPreview(skipParsing = false) {
                if (!enhancedResumeData) return;
                
                // 只有在非拖拽操作时才重新解析编辑器内容
                if (!skipParsing) {
                    // 获取编辑器内容并解析为结构化数据
                    const editorContent = quill.getText();
                    
                    // 智能解析编辑器内容，识别不同的section
                    const parsedData = parseEditorContent(editorContent);
                    
                    // 更新enhancedResumeData，保持原有数据结构
                    if (parsedData.summary !== undefined) {
                        enhancedResumeData.summary = parsedData.summary;
                    }
                    if (parsedData.experience && parsedData.experience.length > 0) {
                        enhancedResumeData.experience = parsedData.experience;
                    }
                    if (parsedData.projects && parsedData.projects.length > 0) {
                        enhancedResumeData.projects = parsedData.projects;
                    }
                    if (parsedData.education && parsedData.education.length > 0) {
                        enhancedResumeData.education = parsedData.education;
                    }
                    if (parsedData.skills && parsedData.skills.length > 0) {
                        enhancedResumeData.skills = parsedData.skills;
                    }
                    if (parsedData.publications && parsedData.publications.length > 0) {
                        enhancedResumeData.publications = parsedData.publications;
                    }
                }

                // 根据section开关状态和顺序构建resume数据
                const sectionOrder = getSectionOrder();
                const resumeData = {
                    personal_info: {
                        name: enhancedResumeData.personal_info?.name || '',
                        email: enhancedResumeData.personal_info?.email || '',
                        phone: enhancedResumeData.personal_info?.phone || ''
                    },
                    section_order: sectionOrder, // 添加section顺序信息
                    summary: document.getElementById('toggle-summary')?.checked ? (enhancedResumeData.summary || '') : '',
                    experience: document.getElementById('toggle-experience')?.checked ? (enhancedResumeData.experience || []) : [],
                    projects: document.getElementById('toggle-projects')?.checked ? (enhancedResumeData.projects || []) : [],
                    education: document.getElementById('toggle-education')?.checked ? (enhancedResumeData.education || []) : [],
                    skills: document.getElementById('toggle-skills')?.checked ? (enhancedResumeData.skills || []) : [],
                    publications: document.getElementById('toggle-publications')?.checked ? (enhancedResumeData.publications || []) : []
                };

                // 发送预览请求
                fetch('/api/preview-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        resume_data: resumeData,
                        template_name: document.getElementById('template-select')?.value || 'default'
                    })
                })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const previewContainer = document.getElementById('pdf-preview-container');
                    const previewIframe = document.getElementById('pdf-preview-iframe');
                    if (previewIframe) {
                        previewIframe.src = url;
                        previewContainer.style.display = 'block';
                    }
                })
                .catch(error => console.error('实时同步错误:', error));
            }

            // 监听编辑器文本变化
            quill.on('text-change', function(delta, oldDelta, source) {
                if (source === 'user' && enhancedResumeData) {
                    // 使用防抖机制，避免频繁请求
                    clearTimeout(syncTimeout);
                    syncTimeout = setTimeout(syncPdfPreview, 1000); // 1秒后同步
                }
            });

            // 监听section开关变化
            function addSectionToggleListeners() {
                // 监听拖拽列表中的checkbox变化
                const sectionOrderList = document.getElementById('section-order-list');
                if (sectionOrderList) {
                    sectionOrderList.addEventListener('change', function(e) {
                        if (e.target.type === 'checkbox' && enhancedResumeData) {
                            // 立即同步PDF预览
                            clearTimeout(syncTimeout);
                            syncPdfPreview(true); // 传入true跳过内容解析
                        }
                    });
                }
                
                // 保持对原有独立checkbox的兼容性（如果存在）
                const toggleIds = ['toggle-summary', 'toggle-experience', 'toggle-projects', 'toggle-education', 'toggle-skills', 'toggle-publications'];
                toggleIds.forEach(id => {
                    const toggle = document.getElementById(id);
                    if (toggle) {
                        toggle.addEventListener('change', function() {
                            if (enhancedResumeData) {
                                // 立即同步PDF预览
                                clearTimeout(syncTimeout);
                                syncPdfPreview(true); // 传入true跳过内容解析
                            }
                        });
                    }
                });
            }

            // 在DOM加载完成后添加监听器
            addSectionToggleListeners();
            
            // 添加拖拽排序功能
            function initSectionDragAndDrop() {
                const sectionOrderList = document.getElementById('section-order-list');
                let draggedElement = null;
                let dropIndicator = null;
                
                // 创建拖拽指示器
                function createDropIndicator() {
                    const indicator = document.createElement('div');
                    indicator.className = 'drop-indicator';
                    return indicator;
                }
                
                // 为每个可拖拽项添加事件监听器
                sectionOrderList.addEventListener('dragstart', function(e) {
                    draggedElement = e.target.closest('li');
                    if (draggedElement) {
                        draggedElement.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/html', draggedElement.outerHTML);
                    }
                });
                
                sectionOrderList.addEventListener('dragend', function(e) {
                    if (draggedElement) {
                        draggedElement.classList.remove('dragging');
                        draggedElement = null;
                    }
                    // 清理所有拖拽相关的样式
                    document.querySelectorAll('.section-item').forEach(item => {
                        item.classList.remove('drag-over');
                    });
                    // 移除拖拽指示器
                    if (dropIndicator && dropIndicator.parentNode) {
                        dropIndicator.parentNode.removeChild(dropIndicator);
                        dropIndicator = null;
                    }
                });
                
                sectionOrderList.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    
                    const targetElement = e.target.closest('li');
                    if (targetElement && targetElement !== draggedElement) {
                        // 清理之前的样式
                        document.querySelectorAll('.section-item').forEach(item => {
                            item.classList.remove('drag-over');
                        });
                        
                        // 添加拖拽悬停样式
                        targetElement.classList.add('drag-over');
                        
                        // 显示拖拽指示器
                        if (!dropIndicator) {
                            dropIndicator = createDropIndicator();
                        }
                        
                        const rect = targetElement.getBoundingClientRect();
                        const midpoint = rect.top + rect.height / 2;
                        
                        if (e.clientY < midpoint) {
                            sectionOrderList.insertBefore(dropIndicator, targetElement);
                        } else {
                            sectionOrderList.insertBefore(dropIndicator, targetElement.nextSibling);
                        }
                        
                        dropIndicator.classList.add('active');
                    }
                });
                
                sectionOrderList.addEventListener('drop', function(e) {
                    e.preventDefault();
                    const targetElement = e.target.closest('li');
                    
                    if (targetElement && draggedElement && targetElement !== draggedElement) {
                        const rect = targetElement.getBoundingClientRect();
                        const midpoint = rect.top + rect.height / 2;
                        
                        if (e.clientY < midpoint) {
                            sectionOrderList.insertBefore(draggedElement, targetElement);
                        } else {
                            sectionOrderList.insertBefore(draggedElement, targetElement.nextSibling);
                        }
                        
                        // 拖拽完成后立即更新PDF预览
                        if (enhancedResumeData) {
                            clearTimeout(syncTimeout);
                            syncPdfPreview(true); // 传入true跳过内容解析
                        }
                    }
                    
                    // 清理拖拽状态
                    document.querySelectorAll('.section-item').forEach(item => {
                        item.classList.remove('drag-over');
                    });
                    if (dropIndicator && dropIndicator.parentNode) {
                        dropIndicator.parentNode.removeChild(dropIndicator);
                        dropIndicator = null;
                    }
                });
                
                // 阻止checkbox点击时触发拖拽
                sectionOrderList.addEventListener('mousedown', function(e) {
                    if (e.target.type === 'checkbox') {
                        e.stopPropagation();
                    }
                });
            }
            
            // 获取当前section顺序
            function getSectionOrder() {
                const orderList = document.getElementById('section-order-list');
                const items = orderList.querySelectorAll('li[data-section]');
                return Array.from(items).map(item => item.getAttribute('data-section'));
            }
            
            // 初始化拖拽功能
            initSectionDragAndDrop();

            document.getElementById('upload-form').addEventListener('submit', function(e) {
                e.preventDefault();
                var formData = new FormData(this);
                quill.setText('Loading...');

                fetch('/upload', {
                    method: 'POST', 
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    enhancedResumeData = data.enhanced_resume; // <-- Correctly access the nested object
                    let resumeHTML = '<div class="resume">';

                    // Left Column
                    resumeHTML += '<div class="left-column">';

                    // Personal Info
                    if (enhancedResumeData.personal_info) {
                        resumeHTML += '<div class="personal-info">';
                        resumeHTML += `<h1 class="name">${enhancedResumeData.personal_info.name || ''}</h1>`;
                        resumeHTML += `<p class="contact">${enhancedResumeData.personal_info.email || ''} | ${enhancedResumeData.personal_info.phone || ''}</p>`;
                        resumeHTML += '</div>';
                    }

                    // Skills
                    if (enhancedResumeData.skills && enhancedResumeData.skills.length > 0) {
                        resumeHTML += '<div class="skills-section">';
                        resumeHTML += '<h2 class="section-title">Skills</h2>';
                        resumeHTML += '<ul class="skills-list">';
                        enhancedResumeData.skills.forEach(skill => {
                            resumeHTML += `<li>${skill}</li>`;
                        });
                        resumeHTML += '</ul>';
                        resumeHTML += '</div>';
                    }

                    // Education
                    if (enhancedResumeData.education && enhancedResumeData.education.length > 0) {
                        resumeHTML += '<div class="education-section">';
                        resumeHTML += '<h2 class="section-title">Education</h2>';
                        enhancedResumeData.education.forEach(edu => {
                            resumeHTML += '<div class="education-item">';
                            resumeHTML += `<p><strong>${edu.degree}</strong> in ${edu.major}</p>`;
                            resumeHTML += `<p>${edu.university}, ${edu.year}</p>`;
                            resumeHTML += '</div>';
                        });
                        resumeHTML += '</div>';
                    }

                    resumeHTML += '</div>'; // close .left-column

                    // Right Column
                    resumeHTML += '<div class="right-column">';

                    // Summary
                    if (enhancedResumeData.summary) {
                        resumeHTML += '<div class="summary-section">';
                        resumeHTML += '<h2 class="section-title">Summary</h2>';
                        resumeHTML += `<p class="summary-text">${enhancedResumeData.summary}</p>`;
                        resumeHTML += '</div>';
                    }

                    // Experience (includes research positions)
                    if (enhancedResumeData.experience && enhancedResumeData.experience.length > 0) {
                        resumeHTML += '<div class="experience-section">';
                        resumeHTML += '<h2 class="section-title">Experience</h2>';
                        enhancedResumeData.experience.forEach(job => {
                            resumeHTML += '<div class="job">';
                            resumeHTML += `<h3 class="job-title">${job.title}</h3>`;
                            resumeHTML += `<p class="company-info">${job.company} | ${job.start_date} - ${job.end_date}</p>`;
                            resumeHTML += '<ul class="job-description">';
                            // 检查description是否为数组
                            if (Array.isArray(job.description)) {
                                job.description.forEach(point => {
                                    resumeHTML += `<li>${point}</li>`;
                                });
                            } else if (job.description) {
                                // 如果description是字符串，直接显示
                                resumeHTML += `<li>${job.description}</li>`;
                            }
                            resumeHTML += '</ul>';
                            resumeHTML += '</div>';
                        });
                        resumeHTML += '</div>';
                    }

                    // Projects
                    if (enhancedResumeData.projects && enhancedResumeData.projects.length > 0) {
                        resumeHTML += '<div class="projects-section">';
                        resumeHTML += '<h2 class="section-title">Projects</h2>';
                        enhancedResumeData.projects.forEach(project => {
                            resumeHTML += '<div class="project">';
                            resumeHTML += `<h3 class="project-name">${project.name}</h3>`;
                            if (project.dates || project.date) {
                                resumeHTML += `<p class="project-date">${project.dates || project.date}</p>`;
                            }
                            resumeHTML += '<ul class="project-description">';
                            // 检查description是否为数组
                            if (Array.isArray(project.description)) {
                                project.description.forEach(point => {
                                    resumeHTML += `<li>${point}</li>`;
                                });
                            } else if (project.description) {
                                // 如果description是字符串，直接显示
                                resumeHTML += `<li>${project.description}</li>`;
                            }
                            resumeHTML += '</ul>';
                            resumeHTML += '</div>';
                        });
                        resumeHTML += '</div>';
                    }

                    resumeHTML += '</div>'; // close .right-column

                    resumeHTML += '</div>'; // close .resume

                    quill.setText(''); // Clear the editor
                    quill.clipboard.dangerouslyPasteHTML(0, resumeHTML);
                    enhancedResumeData.cleanHTML = resumeHTML; // Store clean HTML
                })
                .catch(error => {
                    console.error('There has been a problem with your fetch operation:', error);
                    alert('Error optimizing resume. Please check the console for details.');
                    quill.setText('Error generating resume.');
                });
            });

            document.getElementById('download-btn').addEventListener('click', function() {
                if (!enhancedResumeData) {
                    alert("Please generate a resume first.");
                    return;
                }

                // Send structured resume data instead of HTML
                const sectionOrder = getSectionOrder();
                const resumeData = {
                    personal_info: {
                        name: enhancedResumeData.personal_info?.name || '',
                        email: enhancedResumeData.personal_info?.email || '',
                        phone: enhancedResumeData.personal_info?.phone || ''
                    },
                    section_order: sectionOrder, // 添加section顺序信息
                    summary: document.getElementById('toggle-summary')?.checked ? (enhancedResumeData.summary || '') : '',
                    experience: document.getElementById('toggle-experience')?.checked ? (enhancedResumeData.experience || []) : [],
                    projects: document.getElementById('toggle-projects')?.checked ? (enhancedResumeData.projects || []) : [],
                    education: document.getElementById('toggle-education')?.checked ? (enhancedResumeData.education || []) : [],
                    skills: document.getElementById('toggle-skills')?.checked ? (enhancedResumeData.skills || []) : [],
                    publications: document.getElementById('toggle-publications')?.checked ? (enhancedResumeData.publications || []) : []
                };

                fetch('/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        resume_data: resumeData,
                        template_name: document.getElementById('template-select').value
                    })
                })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'resume.pdf';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => console.error('Error:', error));
            });

            document.getElementById('preview-btn').addEventListener('click', function() {
                if (!enhancedResumeData) {
                    alert("Please generate a resume first.");
                    return;
                }

                // Send structured resume data instead of HTML
                const sectionOrder = getSectionOrder();
                const resumeData = {
                    personal_info: {
                        name: enhancedResumeData.personal_info?.name || '',
                        email: enhancedResumeData.personal_info?.email || '',
                        phone: enhancedResumeData.personal_info?.phone || ''
                    },
                    section_order: sectionOrder, // 添加section顺序信息
                    summary: document.getElementById('toggle-summary')?.checked ? (enhancedResumeData.summary || '') : '',
                    experience: document.getElementById('toggle-experience')?.checked ? (enhancedResumeData.experience || []) : [],
                    projects: document.getElementById('toggle-projects')?.checked ? (enhancedResumeData.projects || []) : [],
                    education: document.getElementById('toggle-education')?.checked ? (enhancedResumeData.education || []) : [],
                    skills: document.getElementById('toggle-skills')?.checked ? (enhancedResumeData.skills || []) : [],
                    publications: document.getElementById('toggle-publications')?.checked ? (enhancedResumeData.publications || []) : []
                };

                fetch('/api/preview-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        resume_data: resumeData,
                        template_name: document.getElementById('template-select').value
                    })
                })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const previewContainer = document.getElementById('pdf-preview-container');
                    const previewIframe = document.getElementById('pdf-preview-iframe');
                    previewIframe.src = url;
                    previewContainer.style.display = 'block';
                })
                .catch(error => console.error('Error:', error));
            });
        });
    </script>
</body>
</html>
