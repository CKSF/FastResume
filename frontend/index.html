<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Optimizer</title>
    <!-- Include Quill stylesheet -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        /* Basic styling for the app */
        body {
            font-family: sans-serif;
            line-height: 1.6;
            margin: 20px;
        }
        h1, h2 {
            color: #333;
        }
        textarea, input[type="file"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        input[type="submit"], button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        input[type="submit"]:hover, button:hover {
            background-color: #45a049;
        }
        hr {
            margin: 20px 0;
        }
        
        /* æ–°å¢ï¼šå¹¶è¡Œå¸ƒå±€æ ·å¼ */
        .main-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .left-panel {
            flex: 1;
            min-width: 0; /* é˜²æ­¢flexé¡¹ç›®æº¢å‡º */
        }
        
        .right-panel {
            flex: 1;
            min-width: 0;
        }
        
        #editor {
            border: 1px solid #ccc;
            height: 400px;
        }
        
        #pdf-preview-container {
            margin-top: 0;
        }
        
        #pdf-preview-iframe {
            width: 100%;
            height: 1000px;
            border: 1px solid #ccc;
        }
        
        .section-item:hover {
            background: #d4edda !important;
            border-color: #a3d4a8 !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section-item.dragging {
            opacity: 0.6 !important;
            transform: rotate(2deg) !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
            z-index: 1000;
        }
        
        .section-item.drag-over {
            border-color: #007bff !important;
            background: #e3f2fd !important;
            border-width: 2px !important;
        }
        
        .drag-handle {
            opacity: 0.5;
            transition: opacity 0.2s ease;
        }
        
        .section-item:hover .drag-handle {
            opacity: 1;
        }
        
        .drop-indicator {
            height: 3px;
            background: #007bff;
            margin: 2px 0;
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .drop-indicator.active {
            opacity: 1;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <h1>Resume Optimizer</h1>
    <p style="color:grey; font-size: 0.9em;">For your privacy, personal identifiable information (such as emails and phone numbers) will be automatically redacted before processing.</p>
    <form id="upload-form" action="/upload" method="post" enctype="multipart/form-data">
        <h2>Job Description</h2>
        <textarea name="job_description" rows="10" cols="50"></textarea>
        <h2>Resume</h2>
        <input type="file" name="resume">
        <br><br>
        <input type="submit" value="Optimize Resume">
    </form>

    <hr>

    <div class="main-container">
        <div class="left-panel">
            <h2>Enhanced Resume</h2>
            <div id="editor"></div>
            <br>
            
            <!-- Section Toggle Controls -->
            <div id="section-controls" style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9;">
                <h3 style="margin-top: 0;">ç®€å†éƒ¨åˆ†æ§åˆ¶</h3>
                
                <!-- Integrated Section Order and Toggle Control -->
                <div style="margin-bottom: 15px;">
                    <h4 style="margin: 10px 0 5px 0; font-size: 14px;">éƒ¨åˆ†é¡ºåºä¸æ˜¾ç¤ºæ§åˆ¶ (æ‹–æ‹½è°ƒæ•´é¡ºåºï¼Œå‹¾é€‰æ§åˆ¶æ˜¾ç¤º):</h4>
                    <ul id="section-order-list" style="list-style: none; padding: 0; margin: 0;">
                        <li draggable="true" data-section="summary" class="section-item" style="padding: 8px 12px; margin: 3px 0; background: #e8f4f8; border: 1px solid #b8d4da; border-radius: 5px; cursor: move; display: flex; align-items: center; transition: all 0.2s ease;">
                            <input type="checkbox" id="toggle-summary" checked style="margin-right: 10px; cursor: pointer;">
                            <span class="drag-handle" style="margin-right: 8px; color: #666; font-size: 12px;">â‹®â‹®</span>
                            <span class="section-label">ğŸ“ ä¸ªäººæ€»ç»“</span>
                        </li>
                        <li draggable="true" data-section="experience" class="section-item" style="padding: 8px 12px; margin: 3px 0; background: #e8f4f8; border: 1px solid #b8d4da; border-radius: 5px; cursor: move; display: flex; align-items: center; transition: all 0.2s ease;">
                            <input type="checkbox" id="toggle-experience" checked style="margin-right: 10px; cursor: pointer;">
                            <span class="drag-handle" style="margin-right: 8px; color: #666; font-size: 12px;">â‹®â‹®</span>
                            <span class="section-label">ğŸ’¼ å·¥ä½œç»å†</span>
                        </li>
                        <li draggable="true" data-section="projects" class="section-item" style="padding: 8px 12px; margin: 3px 0; background: #e8f4f8; border: 1px solid #b8d4da; border-radius: 5px; cursor: move; display: flex; align-items: center; transition: all 0.2s ease;">
                            <input type="checkbox" id="toggle-projects" checked style="margin-right: 10px; cursor: pointer;">
                            <span class="drag-handle" style="margin-right: 8px; color: #666; font-size: 12px;">â‹®â‹®</span>
                            <span class="section-label">ğŸš€ é¡¹ç›®ç»å†</span>
                        </li>
                        <li draggable="true" data-section="education" class="section-item" style="padding: 8px 12px; margin: 3px 0; background: #e8f4f8; border: 1px solid #b8d4da; border-radius: 5px; cursor: move; display: flex; align-items: center; transition: all 0.2s ease;">
                            <input type="checkbox" id="toggle-education" checked style="margin-right: 10px; cursor: pointer;">
                            <span class="drag-handle" style="margin-right: 8px; color: #666; font-size: 12px;">â‹®â‹®</span>
                            <span class="section-label">ğŸ“ æ•™è‚²èƒŒæ™¯</span>
                        </li>
                        <li draggable="true" data-section="skills" class="section-item" style="padding: 8px 12px; margin: 3px 0; background: #e8f4f8; border: 1px solid #b8d4da; border-radius: 5px; cursor: move; display: flex; align-items: center; transition: all 0.2s ease;">
                            <input type="checkbox" id="toggle-skills" checked style="margin-right: 10px; cursor: pointer;">
                            <span class="drag-handle" style="margin-right: 8px; color: #666; font-size: 12px;">â‹®â‹®</span>
                            <span class="section-label">âš¡ æŠ€èƒ½ä¸“é•¿</span>
                        </li>
                        <li draggable="true" data-section="publications" class="section-item" style="padding: 8px 12px; margin: 3px 0; background: #e8f4f8; border: 1px solid #b8d4da; border-radius: 5px; cursor: move; display: flex; align-items: center; transition: all 0.2s ease;">
                            <input type="checkbox" id="toggle-publications" checked style="margin-right: 10px; cursor: pointer;">
                            <span class="drag-handle" style="margin-right: 8px; color: #666; font-size: 12px;">â‹®â‹®</span>
                            <span class="section-label">ğŸ“š å‘è¡¨è®ºæ–‡</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <label for="template-select">Choose a template:</label>
            <select name="templates" id="template-select">
                <option value="default.html">Default</option>
            </select>
            <button id="download-btn">Download as PDF</button>
            <button id="preview-btn">Real-time Preview</button>
        </div>
        
        <div class="right-panel">
            <div id="pdf-preview-container" style="display: none;">
                <h3>PDF Preview</h3>
                <iframe id="pdf-preview-iframe"></iframe>
            </div>
        </div>
    </div>

    <!-- Include the Quill library -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let enhancedResumeData = null;
            let syncTimeout = null;
            
            var quill = new Quill('#editor', {
                theme: 'snow'
            });

            // æ™ºèƒ½è§£æç¼–è¾‘å™¨å†…å®¹çš„å‡½æ•°
            function parseEditorContent(content) {
                const lines = content.split('\n').filter(line => line.trim());
                const parsedData = {};
                let currentSection = null;
                let currentItem = null;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // è¯†åˆ«sectionæ ‡é¢˜
                    if (line.toLowerCase().includes('summary') || line.toLowerCase().includes('ä¸ªäººæ€»ç»“')) {
                        currentSection = 'summary';
                        continue;
                    } else if (line.toLowerCase().includes('experience') || line.toLowerCase().includes('å·¥ä½œç»å†')) {
                        currentSection = 'experience';
                        parsedData.experience = [];
                        currentItem = null;
                        continue;
                    } else if (line.toLowerCase().includes('projects') || line.toLowerCase().includes('é¡¹ç›®ç»å†')) {
                        currentSection = 'projects';
                        parsedData.projects = [];
                        currentItem = null;
                        continue;
                    } else if (line.toLowerCase().includes('education') || line.toLowerCase().includes('æ•™è‚²èƒŒæ™¯')) {
                        currentSection = 'education';
                        parsedData.education = [];
                        currentItem = null;
                        continue;
                    } else if (line.toLowerCase().includes('skills') || line.toLowerCase().includes('æŠ€èƒ½ä¸“é•¿')) {
                        currentSection = 'skills';
                        parsedData.skills = [];
                        currentItem = null;
                        continue;
                    } else if (line.toLowerCase().includes('publications') || line.toLowerCase().includes('å‘è¡¨è®ºæ–‡')) {
                        currentSection = 'publications';
                        parsedData.publications = [];
                        currentItem = null;
                        continue;
                    }
                    
                    // æ ¹æ®å½“å‰sectionå¤„ç†å†…å®¹
                    if (currentSection === 'summary') {
                        if (!parsedData.summary) parsedData.summary = '';
                        parsedData.summary += (parsedData.summary ? ' ' : '') + line;
                    } else if (currentSection === 'experience') {
                        // æ£€æµ‹æ—¥æœŸæ ¼å¼ (å¦‚ "Sep 2024 â€“ Present", "Jan 2024 â€“ Jan 2025")
                        const datePattern = /\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|\d{4})\s*[â€“-]\s*(Present|\d{4}|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i;
                        
                        if (datePattern.test(line)) {
                            // è¿™æ˜¯æ—¥æœŸè¡Œï¼Œåº”è¯¥å±äºå½“å‰é¡¹ç›®
                            if (currentItem) {
                                const dates = line.split(/[â€“-]/).map(d => d.trim());
                                currentItem.start_date = dates[0] || '';
                                currentItem.end_date = dates[1] || '';
                            }
                        } else if (line.startsWith('â€¢') || line.startsWith('-') || line.startsWith('*') || line.startsWith('â—¦')) {
                            // è¿™æ˜¯æè¿°é¡¹
                            if (currentItem) {
                                currentItem.description.push(line.replace(/^[â€¢\-*â—¦]\s*/, ''));
                            }
                        } else if (line && !line.match(/^\s*$/)) {
                            // è¿™å¯èƒ½æ˜¯æ–°çš„å·¥ä½œé¡¹ç›®æ ‡é¢˜
                            currentItem = {
                                company: line,
                                title: '',
                                start_date: '',
                                end_date: '',
                                description: []
                            };
                            parsedData.experience.push(currentItem);
                        }
                    } else if (currentSection === 'projects') {
                        // æ£€æµ‹æ—¥æœŸæ ¼å¼
                        const datePattern = /\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec|\d{4})\s*[â€“-]\s*(Present|\d{4}|Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i;
                        
                        if (datePattern.test(line)) {
                            // è¿™æ˜¯æ—¥æœŸè¡Œ
                            if (currentItem) {
                                currentItem.date = line;
                                const dates = line.split(/[â€“-]/).map(d => d.trim());
                                currentItem.start_date = dates[0] || '';
                                currentItem.end_date = dates[1] || '';
                            }
                        } else if (line.startsWith('â€¢') || line.startsWith('-') || line.startsWith('*') || line.startsWith('â—¦')) {
                            // è¿™æ˜¯æè¿°é¡¹
                            if (currentItem) {
                                currentItem.description.push(line.replace(/^[â€¢\-*â—¦]\s*/, ''));
                            }
                        } else if (line && !line.match(/^\s*$/)) {
                            // è¿™å¯èƒ½æ˜¯æ–°çš„é¡¹ç›®æ ‡é¢˜
                            currentItem = {
                                name: line,
                                date: '',
                                start_date: '',
                                end_date: '',
                                description: []
                            };
                            parsedData.projects.push(currentItem);
                        }
                    } else if (currentSection === 'skills') {
                        if (line.startsWith('â€¢') || line.startsWith('-') || line.startsWith('*')) {
                            parsedData.skills.push(line.substring(1).trim());
                        } else if (line) {
                            parsedData.skills.push(line);
                        }
                    }
                }
                
                return parsedData;
            }
            
            // æ·»åŠ å®æ—¶åŒæ­¥åŠŸèƒ½
            function syncPdfPreview(skipParsing = false) {
                if (!enhancedResumeData) return;
                
                // åªæœ‰åœ¨éæ‹–æ‹½æ“ä½œæ—¶æ‰é‡æ–°è§£æç¼–è¾‘å™¨å†…å®¹
                if (!skipParsing) {
                    // è·å–ç¼–è¾‘å™¨å†…å®¹å¹¶è§£æä¸ºç»“æ„åŒ–æ•°æ®
                    const editorContent = quill.getText();
                    
                    // æ™ºèƒ½è§£æç¼–è¾‘å™¨å†…å®¹ï¼Œè¯†åˆ«ä¸åŒçš„section
                    const parsedData = parseEditorContent(editorContent);
                    
                    // æ›´æ–°enhancedResumeDataï¼Œä¿æŒåŸæœ‰æ•°æ®ç»“æ„
                    if (parsedData.summary !== undefined) {
                        enhancedResumeData.summary = parsedData.summary;
                    }
                    if (parsedData.experience && parsedData.experience.length > 0) {
                        enhancedResumeData.experience = parsedData.experience;
                    }
                    if (parsedData.projects && parsedData.projects.length > 0) {
                        enhancedResumeData.projects = parsedData.projects;
                    }
                    if (parsedData.education && parsedData.education.length > 0) {
                        enhancedResumeData.education = parsedData.education;
                    }
                    if (parsedData.skills && parsedData.skills.length > 0) {
                        enhancedResumeData.skills = parsedData.skills;
                    }
                    if (parsedData.publications && parsedData.publications.length > 0) {
                        enhancedResumeData.publications = parsedData.publications;
                    }
                }

                // æ ¹æ®sectionå¼€å…³çŠ¶æ€å’Œé¡ºåºæ„å»ºresumeæ•°æ®
                const sectionOrder = getSectionOrder();
                const resumeData = {
                    personal_info: {
                        name: enhancedResumeData.personal_info?.name || '',
                        email: enhancedResumeData.personal_info?.email || '',
                        phone: enhancedResumeData.personal_info?.phone || ''
                    },
                    section_order: sectionOrder, // æ·»åŠ sectioné¡ºåºä¿¡æ¯
                    summary: document.getElementById('toggle-summary')?.checked ? (enhancedResumeData.summary || '') : '',
                    experience: document.getElementById('toggle-experience')?.checked ? (enhancedResumeData.experience || []) : [],
                    projects: document.getElementById('toggle-projects')?.checked ? (enhancedResumeData.projects || []) : [],
                    education: document.getElementById('toggle-education')?.checked ? (enhancedResumeData.education || []) : [],
                    skills: document.getElementById('toggle-skills')?.checked ? (enhancedResumeData.skills || []) : [],
                    publications: document.getElementById('toggle-publications')?.checked ? (enhancedResumeData.publications || []) : []
                };

                // å‘é€é¢„è§ˆè¯·æ±‚
                fetch('/api/preview-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        resume_data: resumeData,
                        template_name: document.getElementById('template-select')?.value || 'default'
                    })
                })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const previewContainer = document.getElementById('pdf-preview-container');
                    const previewIframe = document.getElementById('pdf-preview-iframe');
                    if (previewIframe) {
                        previewIframe.src = url;
                        previewContainer.style.display = 'block';
                    }
                })
                .catch(error => console.error('å®æ—¶åŒæ­¥é”™è¯¯:', error));
            }

            // ç›‘å¬ç¼–è¾‘å™¨æ–‡æœ¬å˜åŒ–
            quill.on('text-change', function(delta, oldDelta, source) {
                if (source === 'user' && enhancedResumeData) {
                    // ä½¿ç”¨é˜²æŠ–æœºåˆ¶ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
                    clearTimeout(syncTimeout);
                    syncTimeout = setTimeout(syncPdfPreview, 1000); // 1ç§’ååŒæ­¥
                }
            });

            // ç›‘å¬sectionå¼€å…³å˜åŒ–
            function addSectionToggleListeners() {
                // ç›‘å¬æ‹–æ‹½åˆ—è¡¨ä¸­çš„checkboxå˜åŒ–
                const sectionOrderList = document.getElementById('section-order-list');
                if (sectionOrderList) {
                    sectionOrderList.addEventListener('change', function(e) {
                        if (e.target.type === 'checkbox' && enhancedResumeData) {
                            // ç«‹å³åŒæ­¥PDFé¢„è§ˆ
                            clearTimeout(syncTimeout);
                            syncPdfPreview(true); // ä¼ å…¥trueè·³è¿‡å†…å®¹è§£æ
                        }
                    });
                }
                
                // ä¿æŒå¯¹åŸæœ‰ç‹¬ç«‹checkboxçš„å…¼å®¹æ€§ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const toggleIds = ['toggle-summary', 'toggle-experience', 'toggle-projects', 'toggle-education', 'toggle-skills', 'toggle-publications'];
                toggleIds.forEach(id => {
                    const toggle = document.getElementById(id);
                    if (toggle) {
                        toggle.addEventListener('change', function() {
                            if (enhancedResumeData) {
                                // ç«‹å³åŒæ­¥PDFé¢„è§ˆ
                                clearTimeout(syncTimeout);
                                syncPdfPreview(true); // ä¼ å…¥trueè·³è¿‡å†…å®¹è§£æ
                            }
                        });
                    }
                });
            }

            // åœ¨DOMåŠ è½½å®Œæˆåæ·»åŠ ç›‘å¬å™¨
            addSectionToggleListeners();
            
            // æ·»åŠ æ‹–æ‹½æ’åºåŠŸèƒ½
            function initSectionDragAndDrop() {
                const sectionOrderList = document.getElementById('section-order-list');
                let draggedElement = null;
                let dropIndicator = null;
                
                // åˆ›å»ºæ‹–æ‹½æŒ‡ç¤ºå™¨
                function createDropIndicator() {
                    const indicator = document.createElement('div');
                    indicator.className = 'drop-indicator';
                    return indicator;
                }
                
                // ä¸ºæ¯ä¸ªå¯æ‹–æ‹½é¡¹æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                sectionOrderList.addEventListener('dragstart', function(e) {
                    draggedElement = e.target.closest('li');
                    if (draggedElement) {
                        draggedElement.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/html', draggedElement.outerHTML);
                    }
                });
                
                sectionOrderList.addEventListener('dragend', function(e) {
                    if (draggedElement) {
                        draggedElement.classList.remove('dragging');
                        draggedElement = null;
                    }
                    // æ¸…ç†æ‰€æœ‰æ‹–æ‹½ç›¸å…³çš„æ ·å¼
                    document.querySelectorAll('.section-item').forEach(item => {
                        item.classList.remove('drag-over');
                    });
                    // ç§»é™¤æ‹–æ‹½æŒ‡ç¤ºå™¨
                    if (dropIndicator && dropIndicator.parentNode) {
                        dropIndicator.parentNode.removeChild(dropIndicator);
                        dropIndicator = null;
                    }
                });
                
                sectionOrderList.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    
                    const targetElement = e.target.closest('li');
                    if (targetElement && targetElement !== draggedElement) {
                        // æ¸…ç†ä¹‹å‰çš„æ ·å¼
                        document.querySelectorAll('.section-item').forEach(item => {
                            item.classList.remove('drag-over');
                        });
                        
                        // æ·»åŠ æ‹–æ‹½æ‚¬åœæ ·å¼
                        targetElement.classList.add('drag-over');
                        
                        // æ˜¾ç¤ºæ‹–æ‹½æŒ‡ç¤ºå™¨
                        if (!dropIndicator) {
                            dropIndicator = createDropIndicator();
                        }
                        
                        const rect = targetElement.getBoundingClientRect();
                        const midpoint = rect.top + rect.height / 2;
                        
                        if (e.clientY < midpoint) {
                            sectionOrderList.insertBefore(dropIndicator, targetElement);
                        } else {
                            sectionOrderList.insertBefore(dropIndicator, targetElement.nextSibling);
                        }
                        
                        dropIndicator.classList.add('active');
                    }
                });
                
                sectionOrderList.addEventListener('drop', function(e) {
                    e.preventDefault();
                    const targetElement = e.target.closest('li');
                    
                    if (targetElement && draggedElement && targetElement !== draggedElement) {
                        const rect = targetElement.getBoundingClientRect();
                        const midpoint = rect.top + rect.height / 2;
                        
                        if (e.clientY < midpoint) {
                            sectionOrderList.insertBefore(draggedElement, targetElement);
                        } else {
                            sectionOrderList.insertBefore(draggedElement, targetElement.nextSibling);
                        }
                        
                        // æ‹–æ‹½å®Œæˆåç«‹å³æ›´æ–°PDFé¢„è§ˆ
                        if (enhancedResumeData) {
                            clearTimeout(syncTimeout);
                            syncPdfPreview(true); // ä¼ å…¥trueè·³è¿‡å†…å®¹è§£æ
                        }
                    }
                    
                    // æ¸…ç†æ‹–æ‹½çŠ¶æ€
                    document.querySelectorAll('.section-item').forEach(item => {
                        item.classList.remove('drag-over');
                    });
                    if (dropIndicator && dropIndicator.parentNode) {
                        dropIndicator.parentNode.removeChild(dropIndicator);
                        dropIndicator = null;
                    }
                });
                
                // é˜»æ­¢checkboxç‚¹å‡»æ—¶è§¦å‘æ‹–æ‹½
                sectionOrderList.addEventListener('mousedown', function(e) {
                    if (e.target.type === 'checkbox') {
                        e.stopPropagation();
                    }
                });
            }
            
            // è·å–å½“å‰sectioné¡ºåº
            function getSectionOrder() {
                const orderList = document.getElementById('section-order-list');
                const items = orderList.querySelectorAll('li[data-section]');
                return Array.from(items).map(item => item.getAttribute('data-section'));
            }
            
            // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
            initSectionDragAndDrop();

            document.getElementById('upload-form').addEventListener('submit', function(e) {
                e.preventDefault();
                var formData = new FormData(this);
                quill.setText('Loading...');

                fetch('/upload', {
                    method: 'POST', 
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    enhancedResumeData = data.enhanced_resume; // <-- Correctly access the nested object
                    let resumeHTML = '<div class="resume">';

                    // Left Column
                    resumeHTML += '<div class="left-column">';

                    // Personal Info
                    if (enhancedResumeData.personal_info) {
                        resumeHTML += '<div class="personal-info">';
                        resumeHTML += `<h1 class="name">${enhancedResumeData.personal_info.name || ''}</h1>`;
                        resumeHTML += `<p class="contact">${enhancedResumeData.personal_info.email || ''} | ${enhancedResumeData.personal_info.phone || ''}</p>`;
                        resumeHTML += '</div>';
                    }

                    // Skills
                    if (enhancedResumeData.skills && enhancedResumeData.skills.length > 0) {
                        resumeHTML += '<div class="skills-section">';
                        resumeHTML += '<h2 class="section-title">Skills</h2>';
                        resumeHTML += '<ul class="skills-list">';
                        enhancedResumeData.skills.forEach(skill => {
                            resumeHTML += `<li>${skill}</li>`;
                        });
                        resumeHTML += '</ul>';
                        resumeHTML += '</div>';
                    }

                    // Education
                    if (enhancedResumeData.education && enhancedResumeData.education.length > 0) {
                        resumeHTML += '<div class="education-section">';
                        resumeHTML += '<h2 class="section-title">Education</h2>';
                        enhancedResumeData.education.forEach(edu => {
                            resumeHTML += '<div class="education-item">';
                            resumeHTML += `<p><strong>${edu.degree}</strong> in ${edu.major}</p>`;
                            resumeHTML += `<p>${edu.university}, ${edu.year}</p>`;
                            resumeHTML += '</div>';
                        });
                        resumeHTML += '</div>';
                    }

                    resumeHTML += '</div>'; // close .left-column

                    // Right Column
                    resumeHTML += '<div class="right-column">';

                    // Summary
                    if (enhancedResumeData.summary) {
                        resumeHTML += '<div class="summary-section">';
                        resumeHTML += '<h2 class="section-title">Summary</h2>';
                        resumeHTML += `<p class="summary-text">${enhancedResumeData.summary}</p>`;
                        resumeHTML += '</div>';
                    }

                    // Experience (includes research positions)
                    if (enhancedResumeData.experience && enhancedResumeData.experience.length > 0) {
                        resumeHTML += '<div class="experience-section">';
                        resumeHTML += '<h2 class="section-title">Experience</h2>';
                        enhancedResumeData.experience.forEach(job => {
                            resumeHTML += '<div class="job">';
                            resumeHTML += `<h3 class="job-title">${job.title}</h3>`;
                            resumeHTML += `<p class="company-info">${job.company} | ${job.start_date} - ${job.end_date}</p>`;
                            resumeHTML += '<ul class="job-description">';
                            // æ£€æŸ¥descriptionæ˜¯å¦ä¸ºæ•°ç»„
                            if (Array.isArray(job.description)) {
                                job.description.forEach(point => {
                                    resumeHTML += `<li>${point}</li>`;
                                });
                            } else if (job.description) {
                                // å¦‚æœdescriptionæ˜¯å­—ç¬¦ä¸²ï¼Œç›´æ¥æ˜¾ç¤º
                                resumeHTML += `<li>${job.description}</li>`;
                            }
                            resumeHTML += '</ul>';
                            resumeHTML += '</div>';
                        });
                        resumeHTML += '</div>';
                    }

                    // Projects
                    if (enhancedResumeData.projects && enhancedResumeData.projects.length > 0) {
                        resumeHTML += '<div class="projects-section">';
                        resumeHTML += '<h2 class="section-title">Projects</h2>';
                        enhancedResumeData.projects.forEach(project => {
                            resumeHTML += '<div class="project">';
                            resumeHTML += `<h3 class="project-name">${project.name}</h3>`;
                            if (project.dates || project.date) {
                                resumeHTML += `<p class="project-date">${project.dates || project.date}</p>`;
                            }
                            resumeHTML += '<ul class="project-description">';
                            // æ£€æŸ¥descriptionæ˜¯å¦ä¸ºæ•°ç»„
                            if (Array.isArray(project.description)) {
                                project.description.forEach(point => {
                                    resumeHTML += `<li>${point}</li>`;
                                });
                            } else if (project.description) {
                                // å¦‚æœdescriptionæ˜¯å­—ç¬¦ä¸²ï¼Œç›´æ¥æ˜¾ç¤º
                                resumeHTML += `<li>${project.description}</li>`;
                            }
                            resumeHTML += '</ul>';
                            resumeHTML += '</div>';
                        });
                        resumeHTML += '</div>';
                    }

                    resumeHTML += '</div>'; // close .right-column

                    resumeHTML += '</div>'; // close .resume

                    quill.setText(''); // Clear the editor
                    quill.clipboard.dangerouslyPasteHTML(0, resumeHTML);
                    enhancedResumeData.cleanHTML = resumeHTML; // Store clean HTML
                })
                .catch(error => {
                    console.error('There has been a problem with your fetch operation:', error);
                    alert('Error optimizing resume. Please check the console for details.');
                    quill.setText('Error generating resume.');
                });
            });

            document.getElementById('download-btn').addEventListener('click', function() {
                if (!enhancedResumeData) {
                    alert("Please generate a resume first.");
                    return;
                }

                // Send structured resume data instead of HTML
                const sectionOrder = getSectionOrder();
                const resumeData = {
                    personal_info: {
                        name: enhancedResumeData.personal_info?.name || '',
                        email: enhancedResumeData.personal_info?.email || '',
                        phone: enhancedResumeData.personal_info?.phone || ''
                    },
                    section_order: sectionOrder, // æ·»åŠ sectioné¡ºåºä¿¡æ¯
                    summary: document.getElementById('toggle-summary')?.checked ? (enhancedResumeData.summary || '') : '',
                    experience: document.getElementById('toggle-experience')?.checked ? (enhancedResumeData.experience || []) : [],
                    projects: document.getElementById('toggle-projects')?.checked ? (enhancedResumeData.projects || []) : [],
                    education: document.getElementById('toggle-education')?.checked ? (enhancedResumeData.education || []) : [],
                    skills: document.getElementById('toggle-skills')?.checked ? (enhancedResumeData.skills || []) : [],
                    publications: document.getElementById('toggle-publications')?.checked ? (enhancedResumeData.publications || []) : []
                };

                fetch('/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        resume_data: resumeData,
                        template_name: document.getElementById('template-select').value
                    })
                })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'resume.pdf';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => console.error('Error:', error));
            });

            document.getElementById('preview-btn').addEventListener('click', function() {
                if (!enhancedResumeData) {
                    alert("Please generate a resume first.");
                    return;
                }

                // Send structured resume data instead of HTML
                const sectionOrder = getSectionOrder();
                const resumeData = {
                    personal_info: {
                        name: enhancedResumeData.personal_info?.name || '',
                        email: enhancedResumeData.personal_info?.email || '',
                        phone: enhancedResumeData.personal_info?.phone || ''
                    },
                    section_order: sectionOrder, // æ·»åŠ sectioné¡ºåºä¿¡æ¯
                    summary: document.getElementById('toggle-summary')?.checked ? (enhancedResumeData.summary || '') : '',
                    experience: document.getElementById('toggle-experience')?.checked ? (enhancedResumeData.experience || []) : [],
                    projects: document.getElementById('toggle-projects')?.checked ? (enhancedResumeData.projects || []) : [],
                    education: document.getElementById('toggle-education')?.checked ? (enhancedResumeData.education || []) : [],
                    skills: document.getElementById('toggle-skills')?.checked ? (enhancedResumeData.skills || []) : [],
                    publications: document.getElementById('toggle-publications')?.checked ? (enhancedResumeData.publications || []) : []
                };

                fetch('/api/preview-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        resume_data: resumeData,
                        template_name: document.getElementById('template-select').value
                    })
                })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const previewContainer = document.getElementById('pdf-preview-container');
                    const previewIframe = document.getElementById('pdf-preview-iframe');
                    previewIframe.src = url;
                    previewContainer.style.display = 'block';
                })
                .catch(error => console.error('Error:', error));
            });
        });
    </script>
</body>
</html>
